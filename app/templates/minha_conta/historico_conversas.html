<!-- Parte 9 -->

{% extends "base.html" %}

{% block title %}Histórico de Conversas - Flub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Histórico de Conversas</h2>
            <div>
                <a href="{{ url_for('minha_conta.minha_conta') }}" class="btn btn-outline-secondary">
                    Voltar
                </a>
            </div>
        </div>

        {% if conversas %}
            <div class="card border-0 shadow">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">Todas as suas conversas ({{ conversas|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for conversa in conversas %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1">
                                            <a href="{{ url_for('minha_conta.ver_conversa', conversa_id=conversa.id) }}" 
                                               class="text-decoration-none text-dark">
                                                {{ conversa.title }}
                                            </a>
                                        </h5>
                                        <p class="mb-1 text-muted">
                                            {% set mensagens_count = conversa.messages.count() %}
                                            {{ mensagens_count }} mensagem{{ 's' if mensagens_count != 1 else '' }}
                                        </p>
                                        <small class="text-muted hora-criacao" data-utc="{{ conversa.created_at.isoformat() }}">
                                            Criada em: {{ conversa.created_at.strftime('%d/%m/%Y %H:%M') }}
                                        </small>
                                        <br>
                                        <small class="text-muted hora-atualizacao" data-utc="{{ conversa.updated_at.isoformat() }}">
                                             Última mensagem: {{ conversa.updated_at.strftime('%d/%m/%Y %H:%M') }}
                                        </small>
                                    </div>
                                    <div class="d-flex flex-column align-items-end">
                                        <form method="POST" 
                                              action="{{ url_for('minha_conta.apagar_conversa', conversa_id=conversa.id) }}"
                                              onsubmit="return confirm('Tem certeza que deseja apagar esta conversa?');">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                Apagar
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-light text-center border-0 shadow">
                <h4>Nenhuma conversa encontrada</h4>
                <p class="mb-3">Você ainda não tem conversas salvas.</p>
                <a href="{{ url_for('minha_conta.nova_conversa') }}" class="btn btn-dark me-2">
                    Nova Conversa
                </a>
                <a href="{{ url_for('minha_conta.minha_conta') }}" class="btn btn-outline-secondary">
                    Voltar para Minha Conta
                </a>
            </div>
        {% endif %}

        {% if conversas %}
        <div class="card mt-3 border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2">
                    <strong>Total de conversas:</strong> {{ conversas|length }}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white">
                <h6 class="mb-0">Estatísticas</h6>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Total:</strong> {{ conversas|length }} conversas</p>
                <p class="mb-0"><strong>Usuário:</strong> {{ current_user.username }}</p>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">Configurações</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('minha_conta.apagar_todas_conversas') }}" class="btn btn-outline-warning btn-sm">
                        Apagar Todas as Conversas
                    </a>
                    <a href="{{ url_for('minha_conta.apagar_conta') }}" class="btn btn-outline-secondary btn-sm">
                        Gerenciar Conta
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para converter UTC para horário local de Brasília
    function convertUTCToBrasilia(utcString, incluirHora = true) {
        try {
            const utcDate = new Date(utcString);
            // Ajusta para o fuso horário de Brasília (UTC-3)
            const brasiliaOffset = -3 * 60; // -3 horas em minutos
            const localDate = new Date(utcDate.getTime() + (brasiliaOffset * 60 * 1000));
            
            if (incluirHora) {
                return localDate.toLocaleDateString('pt-BR') + ' ' + localDate.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                return localDate.toLocaleDateString('pt-BR');
            }
        } catch (error) {
            console.error('Erro ao converter horário:', error);
            return incluirHora ? '--/--/---- --:--' : '--/--/----';
        }
    }

    // Converte horários de criação (fixo - primeira mensagem)
    const elementosCriacao = document.querySelectorAll('.hora-criacao');
    elementosCriacao.forEach(element => {
        const utcTimestamp = element.getAttribute('data-utc');
        if (utcTimestamp) {
            const textoOriginal = element.textContent;
            const brasiliaTime = convertUTCToBrasilia(utcTimestamp, true);
            element.textContent = textoOriginal.replace(/\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/, brasiliaTime);
        }
    });

    // Converte horários de atualização (última mensagem)
    const elementosAtualizacao = document.querySelectorAll('.hora-atualizacao');
    elementosAtualizacao.forEach(element => {
        const utcTimestamp = element.getAttribute('data-utc');
        if (utcTimestamp) {
            const textoOriginal = element.textContent;
            const brasiliaTime = convertUTCToBrasilia(utcTimestamp, true);
            element.textContent = textoOriginal.replace(/\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/, brasiliaTime);
        }
    });
});
</script>
{% endblock %}